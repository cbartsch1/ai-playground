// Futures Scalper V3 - Balanced Frequency + Profitability
// More trades while maintaining edge
// For ES/NQ on 1m-5m charts
//@version=5
strategy("Futures Scalper V3", shorttitle="FUT-V3", overlay=true,
         pyramiding=0, initial_capital=10000, currency=currency.USD,
         default_qty_type=strategy.fixed, default_qty_value=1,
         commission_type=strategy.commission.cash_per_contract, commission_value=2.50,
         slippage=1)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS - Relaxed for more trades
// ══════════════════════════════════════════════════════════════════════════════

// Trend (faster EMAs)
emaFast = input.int(5, "Fast EMA", minval=1, group="Trend")
emaSlow = input.int(13, "Slow EMA", minval=1, group="Trend")
emaTrend = input.int(34, "Trend EMA", minval=1, group="Trend")

// Momentum (relaxed)
rsiLen = input.int(7, "RSI Length", group="Momentum")
useRsiFilter = input.bool(true, "Use RSI Filter", group="Momentum")
rsiLongMin = input.int(45, "RSI Long Min", group="Momentum")
rsiShortMax = input.int(55, "RSI Short Max", group="Momentum")

// VWAP (optional)
useVwap = input.bool(false, "Use VWAP Filter", group="VWAP")

// Risk - Keep the good R:R
slTicks = input.float(6, "Stop Loss (ticks)", minval=1, group="Risk")
tpTicks = input.float(15, "Take Profit (ticks)", minval=1, group="Risk")
useTrail = input.bool(true, "Use Trailing Stop", group="Risk")
trailActivate = input.float(8, "Trail After (ticks profit)", group="Risk")
trailOffset = input.float(3, "Trail Offset (ticks)", group="Risk")

// Session
useSession = input.bool(true, "Use Session Filter", group="Session")
sessStart = input.int(935, "Start (5 min after open)", group="Session")
sessEnd = input.int(1555, "End (5 min before close)", group="Session")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// EMAs
emaF = ta.ema(close, emaFast)
emaS = ta.ema(close, emaSlow)
emaT = ta.ema(close, emaTrend)

// RSI
rsi = ta.rsi(close, rsiLen)

// VWAP
vwap = ta.vwap(hlc3)

// Session
timeNow = hour * 100 + minute
inSession = not useSession or (timeNow >= sessStart and timeNow < sessEnd)

// Trend direction (simplified)
bullTrend = emaF > emaS and close > emaT
bearTrend = emaF < emaS and close < emaT

// ══════════════════════════════════════════════════════════════════════════════
// ENTRY SIGNALS - Multiple entry types for more trades
// ══════════════════════════════════════════════════════════════════════════════

// === TYPE 1: EMA Crossover ===
longCross = ta.crossover(emaF, emaS)
shortCross = ta.crossunder(emaF, emaS)

// === TYPE 2: Pullback to Fast EMA ===
longPullback = bullTrend and ta.crossover(low, emaF) and close > emaF
shortPullback = bearTrend and ta.crossunder(high, emaF) and close < emaF

// === TYPE 3: Trend Continuation (price crosses back above/below slow EMA) ===
longContinue = bullTrend and ta.crossover(close, emaS) and emaF > emaS
shortContinue = bearTrend and ta.crossunder(close, emaS) and emaF < emaS

// === FILTERS ===
rsiOkLong = not useRsiFilter or rsi > rsiLongMin
rsiOkShort = not useRsiFilter or rsi < rsiShortMax
vwapOkLong = not useVwap or close > vwap
vwapOkShort = not useVwap or close < vwap

// === FINAL SIGNALS ===
longSignal = (longCross or longPullback or longContinue) and rsiOkLong and vwapOkLong and inSession
shortSignal = (shortCross or shortPullback or shortContinue) and rsiOkShort and vwapOkShort and inSession

// ══════════════════════════════════════════════════════════════════════════════
// TRADE EXECUTION
// ══════════════════════════════════════════════════════════════════════════════

tickSize = syminfo.mintick

// Long
if longSignal and strategy.position_size <= 0
    sl = close - slTicks * tickSize
    tp = close + tpTicks * tickSize

    strategy.entry("Long", strategy.long)

    if useTrail
        strategy.exit("LX", "Long", stop=sl, limit=tp,
                     trail_points=trailActivate, trail_offset=trailOffset)
    else
        strategy.exit("LX", "Long", stop=sl, limit=tp)

// Short
if shortSignal and strategy.position_size >= 0
    sl = close + slTicks * tickSize
    tp = close - tpTicks * tickSize

    strategy.entry("Short", strategy.short)

    if useTrail
        strategy.exit("SX", "Short", stop=sl, limit=tp,
                     trail_points=trailActivate, trail_offset=trailOffset)
    else
        strategy.exit("SX", "Short", stop=sl, limit=tp)

// EOD flatten
if useSession and timeNow >= sessEnd and strategy.position_size != 0
    strategy.close_all("Flat EOD")

// ══════════════════════════════════════════════════════════════════════════════
// VISUALS
// ══════════════════════════════════════════════════════════════════════════════

// EMAs
plot(emaF, "Fast", color.lime, 2)
plot(emaS, "Slow", color.orange, 2)
plot(emaT, "Trend", color.gray, 1)

// VWAP
plot(useVwap ? vwap : na, "VWAP", color.yellow, 2, plot.style_circles)

// Signals
plotshape(longSignal and strategy.position_size <= 0, "Long", shape.triangleup, location.belowbar, color.lime, size=size.small)
plotshape(shortSignal and strategy.position_size >= 0, "Short", shape.triangledown, location.abovebar, color.red, size=size.small)

// Trend background
bgcolor(bullTrend ? color.new(color.green, 93) : bearTrend ? color.new(color.red, 93) : na)

// ══════════════════════════════════════════════════════════════════════════════
// INFO PANEL
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 2, 5, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(t, 0, 0, "V3", text_color=color.yellow, bgcolor=color.new(color.teal, 50))
    table.cell(t, 1, 0, bullTrend ? "BULL" : bearTrend ? "BEAR" : "CHOP", text_color=bullTrend ? color.lime : bearTrend ? color.red : color.gray, bgcolor=color.new(color.teal, 50))

    table.cell(t, 0, 1, "RSI", text_color=color.white)
    table.cell(t, 1, 1, str.tostring(rsi, "#"), text_color=color.white)

    table.cell(t, 0, 2, "SL", text_color=color.white)
    table.cell(t, 1, 2, str.tostring(slTicks) + "t", text_color=color.red)

    table.cell(t, 0, 3, "TP", text_color=color.white)
    table.cell(t, 1, 3, str.tostring(tpTicks) + "t", text_color=color.green)

    table.cell(t, 0, 4, "R:R", text_color=color.white)
    table.cell(t, 1, 4, str.tostring(tpTicks/slTicks, "#.#") + ":1", text_color=color.aqua)
