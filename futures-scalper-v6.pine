// Futures Scalper V6 - Mean Reversion
// DIFFERENT APPROACH: Fade extremes, high win rate, tight targets
// For ES/NQ 5m charts
//@version=5
strategy("Futures Scalper V6", shorttitle="FUT-V6", overlay=true,
         pyramiding=0, initial_capital=10000, currency=currency.USD,
         default_qty_type=strategy.fixed, default_qty_value=1,
         commission_type=strategy.commission.cash_per_contract, commission_value=2.50,
         slippage=1)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// Bollinger Bands (mean reversion levels)
bbLen = input.int(20, "BB Length", group="Bollinger")
bbMult = input.float(2.0, "BB StdDev", step=0.1, group="Bollinger")

// RSI (oversold/overbought)
rsiLen = input.int(7, "RSI Length", group="RSI")
rsiOS = input.int(25, "RSI Oversold", group="RSI")
rsiOB = input.int(75, "RSI Overbought", group="RSI")

// Stochastic (confirmation)
stochK = input.int(14, "Stoch K", group="Stochastic")
stochD = input.int(3, "Stoch D", group="Stochastic")
stochOS = input.int(20, "Stoch Oversold", group="Stochastic")
stochOB = input.int(80, "Stoch Overbought", group="Stochastic")

// Risk - TIGHT targets for high win rate
slTicks = input.float(8, "Stop Loss Ticks", group="Risk")
tpTicks = input.float(10, "Take Profit Ticks", group="Risk")  // 1.25:1 R:R

// Session
sessStart = input.int(945, "Start", group="Session")
sessEnd = input.int(1545, "End", group="Session")

// ══════════════════════════════════════════════════════════════════════════════
// INDICATORS
// ══════════════════════════════════════════════════════════════════════════════

// Bollinger Bands
basis = ta.sma(close, bbLen)
dev = bbMult * ta.stdev(close, bbLen)
upperBB = basis + dev
lowerBB = basis - dev

// RSI
rsi = ta.rsi(close, rsiLen)

// Stochastic
k = ta.stoch(close, high, low, stochK)
d = ta.sma(k, stochD)

// VWAP for bias
vwap = ta.vwap(hlc3)

// Session
timeNow = hour * 100 + minute
inSession = timeNow >= sessStart and timeNow < sessEnd

// ══════════════════════════════════════════════════════════════════════════════
// MEAN REVERSION SIGNALS
// ══════════════════════════════════════════════════════════════════════════════

// === LONG: Price oversold, expect bounce ===
// 1. Price at or below lower BB
// 2. RSI oversold (< 25)
// 3. Stochastic oversold and turning up
// 4. Near VWAP or below (not too extended)

priceAtLowerBB = low <= lowerBB
rsiOversold = rsi < rsiOS
stochOversold = k < stochOS
stochTurningUp = ta.crossover(k, d) or (k > k[1] and k < stochOS + 10)
nearVwap = math.abs(close - vwap) / vwap < 0.005  // Within 0.5% of VWAP

longSignal = priceAtLowerBB and rsiOversold and stochOversold and inSession and strategy.position_size == 0

// === SHORT: Price overbought, expect pullback ===
priceAtUpperBB = high >= upperBB
rsiOverbought = rsi > rsiOB
stochOverbought = k > stochOB
stochTurningDown = ta.crossunder(k, d) or (k < k[1] and k > stochOB - 10)

shortSignal = priceAtUpperBB and rsiOverbought and stochOverbought and inSession and strategy.position_size == 0

// ══════════════════════════════════════════════════════════════════════════════
// EXECUTION
// ══════════════════════════════════════════════════════════════════════════════

tick = syminfo.mintick

if longSignal
    strategy.entry("Long", strategy.long)
    strategy.exit("LX", "Long", stop=close - slTicks*tick, limit=close + tpTicks*tick)

if shortSignal
    strategy.entry("Short", strategy.short)
    strategy.exit("SX", "Short", stop=close + slTicks*tick, limit=close - tpTicks*tick)

// EOD
if timeNow >= sessEnd and strategy.position_size != 0
    strategy.close_all("EOD")

// ══════════════════════════════════════════════════════════════════════════════
// VISUALS
// ══════════════════════════════════════════════════════════════════════════════

// Bollinger Bands
plot(basis, "BB Mid", color.gray, 1)
p1 = plot(upperBB, "BB Upper", color.red, 1)
p2 = plot(lowerBB, "BB Lower", color.green, 1)
fill(p1, p2, color.new(color.purple, 95))

// VWAP
plot(vwap, "VWAP", color.yellow, 2)

// Signals
plotshape(longSignal, "Long", shape.triangleup, location.belowbar, color.lime, size=size.normal)
plotshape(shortSignal, "Short", shape.triangledown, location.abovebar, color.red, size=size.normal)

// Highlight oversold/overbought zones
bgcolor(rsi < rsiOS ? color.new(color.green, 90) : rsi > rsiOB ? color.new(color.red, 90) : na)

// ══════════════════════════════════════════════════════════════════════════════
// INFO PANEL
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 75))
if barstate.islast
    table.cell(t, 0, 0, "V6", text_color=color.black, bgcolor=color.orange)
    table.cell(t, 1, 0, "REVERT", text_color=color.black, bgcolor=color.orange)

    // RSI
    rsiStatus = rsi < rsiOS ? "OVERSOLD" : rsi > rsiOB ? "OVERBOUGHT" : "NEUTRAL"
    rsiCol = rsi < rsiOS ? color.lime : rsi > rsiOB ? color.red : color.gray
    table.cell(t, 0, 1, "RSI", text_color=color.white)
    table.cell(t, 1, 1, str.tostring(rsi, "#") + " " + rsiStatus, text_color=rsiCol)

    // Stochastic
    stochStatus = k < stochOS ? "OVERSOLD" : k > stochOB ? "OVERBOUGHT" : "NEUTRAL"
    stochCol = k < stochOS ? color.lime : k > stochOB ? color.red : color.gray
    table.cell(t, 0, 2, "Stoch", text_color=color.white)
    table.cell(t, 1, 2, str.tostring(k, "#") + " " + stochStatus, text_color=stochCol)

    // BB Position
    bbPos = close > upperBB ? "ABOVE" : close < lowerBB ? "BELOW" : "INSIDE"
    bbCol = close > upperBB ? color.red : close < lowerBB ? color.lime : color.gray
    table.cell(t, 0, 3, "BB", text_color=color.white)
    table.cell(t, 1, 3, bbPos, text_color=bbCol)

    // Session
    table.cell(t, 0, 4, "Session", text_color=color.white)
    table.cell(t, 1, 4, inSession ? "ACTIVE" : "CLOSED", text_color=inSession ? color.lime : color.red)

    // R:R
    table.cell(t, 0, 5, "R:R", text_color=color.white)
    table.cell(t, 1, 5, str.tostring(tpTicks/slTicks, "#.##") + ":1", text_color=color.aqua)
