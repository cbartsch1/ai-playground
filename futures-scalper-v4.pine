// Futures Scalper V4 - Fixed for Profitability
// Added: ADX trend filter, no trailing (let winners run), tighter entries
// For ES/NQ on 5m charts
//@version=5
strategy("Futures Scalper V4", shorttitle="FUT-V4", overlay=true,
         pyramiding=0, initial_capital=10000, currency=currency.USD,
         default_qty_type=strategy.fixed, default_qty_value=1,
         commission_type=strategy.commission.cash_per_contract, commission_value=2.50,
         slippage=1)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS
// ══════════════════════════════════════════════════════════════════════════════

// Trend EMAs
emaFast = input.int(8, "Fast EMA", group="Trend")
emaSlow = input.int(21, "Slow EMA", group="Trend")

// ADX Trend Strength Filter (KEY ADDITION)
adxLen = input.int(14, "ADX Length", group="ADX Filter")
adxThresh = input.int(20, "ADX Min Threshold", group="ADX Filter")

// RSI Momentum
rsiLen = input.int(14, "RSI Length", group="Momentum")

// Risk Management - FIXED stops, no trailing
slTicks = input.float(8, "Stop Loss (ticks)", group="Risk")
tpTicks = input.float(20, "Take Profit (ticks)", group="Risk")

// Session
useSession = input.bool(true, "Use Session", group="Session")
sessStart = input.int(940, "Start", group="Session")
sessEnd = input.int(1550, "End", group="Session")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// EMAs
emaF = ta.ema(close, emaFast)
emaS = ta.ema(close, emaSlow)

// ADX Calculation
[diPlus, diMinus, adxValue] = ta.dmi(adxLen, adxLen)
strongTrend = adxValue > adxThresh

// RSI
rsi = ta.rsi(close, rsiLen)

// Session
timeNow = hour * 100 + minute
inSession = not useSession or (timeNow >= sessStart and timeNow < sessEnd)

// Trend
bullish = emaF > emaS
bearish = emaF < emaS

// ══════════════════════════════════════════════════════════════════════════════
// ENTRY SIGNALS - Only in trending markets
// ══════════════════════════════════════════════════════════════════════════════

// Long: EMA cross + ADX confirms trend + RSI not overbought
longSignal = ta.crossover(emaF, emaS) and strongTrend and diPlus > diMinus and rsi < 70 and inSession

// Short: EMA cross + ADX confirms trend + RSI not oversold
shortSignal = ta.crossunder(emaF, emaS) and strongTrend and diMinus > diPlus and rsi > 30 and inSession

// ══════════════════════════════════════════════════════════════════════════════
// EXECUTION - Simple fixed SL/TP, no trailing
// ══════════════════════════════════════════════════════════════════════════════

tick = syminfo.mintick

if longSignal and strategy.position_size == 0
    strategy.entry("L", strategy.long)
    strategy.exit("LX", "L", stop=close - slTicks*tick, limit=close + tpTicks*tick)

if shortSignal and strategy.position_size == 0
    strategy.entry("S", strategy.short)
    strategy.exit("SX", "S", stop=close + slTicks*tick, limit=close - tpTicks*tick)

// EOD
if useSession and timeNow >= sessEnd and strategy.position_size != 0
    strategy.close_all("EOD")

// ══════════════════════════════════════════════════════════════════════════════
// VISUALS
// ══════════════════════════════════════════════════════════════════════════════

plot(emaF, "Fast", color.lime, 2)
plot(emaS, "Slow", color.red, 2)

// Only show signals when ADX is strong
plotshape(longSignal, "Long", shape.triangleup, location.belowbar, color.lime, size=size.small)
plotshape(shortSignal, "Short", shape.triangledown, location.abovebar, color.red, size=size.small)

// Background: Green=trending bull, Red=trending bear, Gray=no trend
bgCol = strongTrend and bullish ? color.new(color.green, 90) : strongTrend and bearish ? color.new(color.red, 90) : color.new(color.gray, 95)
bgcolor(bgCol)

// ══════════════════════════════════════════════════════════════════════════════
// INFO PANEL
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 80))
if barstate.islast
    table.cell(t, 0, 0, "V4", text_color=color.yellow, bgcolor=color.new(color.purple, 50))
    table.cell(t, 1, 0, strongTrend ? "TREND" : "CHOP", text_color=strongTrend ? color.lime : color.gray, bgcolor=color.new(color.purple, 50))

    table.cell(t, 0, 1, "ADX", text_color=color.white)
    table.cell(t, 1, 1, str.tostring(adxValue, "#"), text_color=adxValue > adxThresh ? color.lime : color.red)

    table.cell(t, 0, 2, "DI+", text_color=color.white)
    table.cell(t, 1, 2, str.tostring(diPlus, "#"), text_color=diPlus > diMinus ? color.lime : color.white)

    table.cell(t, 0, 3, "DI-", text_color=color.white)
    table.cell(t, 1, 3, str.tostring(diMinus, "#"), text_color=diMinus > diPlus ? color.red : color.white)

    table.cell(t, 0, 4, "RSI", text_color=color.white)
    table.cell(t, 1, 4, str.tostring(rsi, "#"), text_color=color.white)

    table.cell(t, 0, 5, "R:R", text_color=color.white)
    table.cell(t, 1, 5, str.tostring(tpTicks/slTicks, "#.#") + ":1", text_color=color.aqua)
