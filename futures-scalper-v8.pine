// Futures Scalper V8 - Based on V2 (the only profitable one)
// V2 had +$102 profit but only 2 trades. This relaxes filters for more trades.
// For ES/NQ 5m charts
//@version=5
strategy("Futures Scalper V8", shorttitle="FUT-V8", overlay=true,
         pyramiding=0, initial_capital=10000, currency=currency.USD,
         default_qty_type=strategy.fixed, default_qty_value=1,
         commission_type=strategy.commission.cash_per_contract, commission_value=2.50,
         slippage=1)

// ══════════════════════════════════════════════════════════════════════════════
// INPUTS (Based on V2 with slight relaxations)
// ══════════════════════════════════════════════════════════════════════════════

// Trend EMAs (V2 used 8/21)
emaFast = input.int(8, "Fast EMA", group="Trend")
emaSlow = input.int(21, "Slow EMA", group="Trend")
emaTrend = input.int(50, "Trend EMA", group="Trend")

// ADX - RELAXED from V2 (was 20, now 15)
adxLen = input.int(14, "ADX Length", group="ADX")
adxThresh = input.int(15, "ADX Threshold", group="ADX")  // Lowered from 20

// RSI - RELAXED
rsiLen = input.int(14, "RSI Length", group="RSI")

// Volume - Made optional
useVolume = input.bool(false, "Require Volume", group="Volume")
volLen = input.int(20, "Volume MA", group="Volume")

// Risk - Same good R:R as V2
slTicks = input.float(8, "Stop Loss Ticks", group="Risk")
tpTicks = input.float(20, "Take Profit Ticks", group="Risk")  // 2.5:1 R:R

// Session - Slightly expanded
sessStart = input.int(935, "Start", group="Session")
sessEnd = input.int(1550, "End", group="Session")

// ══════════════════════════════════════════════════════════════════════════════
// CALCULATIONS
// ══════════════════════════════════════════════════════════════════════════════

// EMAs
emaF = ta.ema(close, emaFast)
emaS = ta.ema(close, emaSlow)
ema50 = ta.ema(close, emaTrend)

// ADX
[diPlus, diMinus, adx] = ta.dmi(adxLen, adxLen)
trending = adx > adxThresh

// RSI
rsi = ta.rsi(close, rsiLen)

// Volume
vol = volume
volMA = ta.sma(vol, volLen)
volOK = not useVolume or vol > volMA * 0.8

// Session
timeNow = hour * 100 + minute
inSession = timeNow >= sessStart and timeNow < sessEnd

// Trend alignment
bullTrend = emaF > emaS and close > ema50
bearTrend = emaF < emaS and close < ema50

// ══════════════════════════════════════════════════════════════════════════════
// ENTRY SIGNALS
// ══════════════════════════════════════════════════════════════════════════════

// Long: EMA cross up + trending + DI+ > DI- + not overbought
longCross = ta.crossover(emaF, emaS)
longSignal = longCross and trending and diPlus > diMinus and rsi < 70 and close > ema50 and volOK and inSession and strategy.position_size == 0

// Short: EMA cross down + trending + DI- > DI+ + not oversold
shortCross = ta.crossunder(emaF, emaS)
shortSignal = shortCross and trending and diMinus > diPlus and rsi > 30 and close < ema50 and volOK and inSession and strategy.position_size == 0

// ══════════════════════════════════════════════════════════════════════════════
// ALSO ADD: Pullback entries (to get more trades)
// ══════════════════════════════════════════════════════════════════════════════

// Long pullback: In uptrend, price dips to fast EMA and bounces
longPB = bullTrend and trending and diPlus > diMinus and low <= emaF and close > emaF and rsi > 40 and rsi < 65 and volOK and inSession and strategy.position_size == 0

// Short pullback: In downtrend, price pops to fast EMA and rejects
shortPB = bearTrend and trending and diMinus > diPlus and high >= emaF and close < emaF and rsi < 60 and rsi > 35 and volOK and inSession and strategy.position_size == 0

// Combined signals
goLong = longSignal or longPB
goShort = shortSignal or shortPB

// ══════════════════════════════════════════════════════════════════════════════
// EXECUTION
// ══════════════════════════════════════════════════════════════════════════════

tick = syminfo.mintick

if goLong
    strategy.entry("Long", strategy.long)
    strategy.exit("LX", "Long", stop=close - slTicks*tick, limit=close + tpTicks*tick)

if goShort
    strategy.entry("Short", strategy.short)
    strategy.exit("SX", "Short", stop=close + slTicks*tick, limit=close - tpTicks*tick)

// EOD
if timeNow >= sessEnd and strategy.position_size != 0
    strategy.close_all("EOD")

// ══════════════════════════════════════════════════════════════════════════════
// VISUALS
// ══════════════════════════════════════════════════════════════════════════════

// EMAs
plot(emaF, "Fast", color.lime, 2)
plot(emaS, "Slow", color.red, 2)
plot(ema50, "50 EMA", color.white, 1)

// Signals
plotshape(goLong, "Long", shape.triangleup, location.belowbar, color.lime, size=size.small)
plotshape(goShort, "Short", shape.triangledown, location.abovebar, color.red, size=size.small)

// Background
bgcolor(trending and bullTrend ? color.new(color.green, 92) : trending and bearTrend ? color.new(color.red, 92) : color.new(color.gray, 95))

// ══════════════════════════════════════════════════════════════════════════════
// INFO PANEL
// ══════════════════════════════════════════════════════════════════════════════

var table t = table.new(position.top_right, 2, 6, bgcolor=color.new(color.black, 75))
if barstate.islast
    table.cell(t, 0, 0, "V8", text_color=color.black, bgcolor=color.lime)
    table.cell(t, 1, 0, trending ? "TREND" : "CHOP", text_color=color.black, bgcolor=trending ? color.lime : color.gray)

    table.cell(t, 0, 1, "ADX", text_color=color.white)
    table.cell(t, 1, 1, str.tostring(adx, "#"), text_color=adx > adxThresh ? color.lime : color.red)

    table.cell(t, 0, 2, "DI", text_color=color.white)
    table.cell(t, 1, 2, diPlus > diMinus ? "DI+ ↑" : "DI- ↓", text_color=diPlus > diMinus ? color.lime : color.red)

    table.cell(t, 0, 3, "RSI", text_color=color.white)
    table.cell(t, 1, 3, str.tostring(rsi, "#"), text_color=color.white)

    table.cell(t, 0, 4, "Bias", text_color=color.white)
    table.cell(t, 1, 4, close > ema50 ? "BULL" : "BEAR", text_color=close > ema50 ? color.lime : color.red)

    table.cell(t, 0, 5, "R:R", text_color=color.white)
    table.cell(t, 1, 5, str.tostring(tpTicks/slTicks, "#.#") + ":1", text_color=color.aqua)
